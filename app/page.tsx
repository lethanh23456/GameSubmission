"use client";
import React, { useState, useRef } from 'react';
import { Send, Heart, AlertCircle, CheckCircle, Zap, Shield, Smile, Frown, Key } from 'lucide-react';

type GameState = 'setup' | 'menu' | 'playing' | 'result';

interface Message {
  text: string;
  isPositive: boolean;
  emoji: string;
}

export default function EmpathyDefender() {
  const [gameState, setGameState] = useState<GameState>('menu');
  const [apiKey, setApiKey] = useState(process.env.NEXT_PUBLIC_OPENAI_API_KEY || '');
  
  // Debug: Log environment variables
  console.log('üîë API Key loaded:', apiKey ? 'Yes (hidden)' : 'No');
  console.log('üåê Base URL:', process.env.NEXT_PUBLIC_BASE_URL);
  
  const [score, setScore] = useState(0);
  const [currentMessage, setCurrentMessage] = useState('');
  const [userInput, setUserInput] = useState('');
  const [loading, setLoading] = useState(false);
  const [feedback, setFeedback] = useState<{ show: boolean; correct: boolean; message: string }>({ 
    show: false, 
    correct: false, 
    message: '' 
  });
  const [streak, setStreak] = useState(0);
  const [emotions, setEmotions] = useState<{ x: number; y: number; emoji: string; id: number }[]>([]);
  const [round, setRound] = useState(0);
  const inputRef = useRef<HTMLInputElement>(null);

  // Ph√¢n t√≠ch c·∫£m x√∫c b·∫±ng OpenAI API
  const analyzeEmotionWithAI = async (text: string): Promise<boolean> => {
    try {
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'gpt-3.5-turbo',
          messages: [
            {
              role: 'system',
              content: 'B·∫°n l√† chuy√™n gia ph√¢n t√≠ch c·∫£m x√∫c. Ph√¢n t√≠ch xem c√¢u n√≥i c√≥ mang t√≠nh ti√™u c·ª±c, b·∫°o l·ª±c, x√∫c ph·∫°m, b·∫Øt n·∫°t hay kh√¥ng. Ch·ªâ tr·∫£ l·ªùi "NEGATIVE" n·∫øu ti√™u c·ª±c ho·∫∑c "POSITIVE" n·∫øu t√≠ch c·ª±c.'
            },
            {
              role: 'user',
              content: `Ph√¢n t√≠ch c√¢u sau: "${text}"`
            }
          ],
          temperature: 0.3,
          max_tokens: 10
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        console.error('API Error:', errorData);
        throw new Error('API request failed');
      }

      const data = await response.json();
      
      if (!data.choices || !data.choices[0] || !data.choices[0].message) {
        console.error('Invalid API response:', data);
        throw new Error('Invalid API response format');
      }
      
      const result = data.choices[0].message.content.trim().toLowerCase();
      return result.includes('negative');
    } catch (error) {
      console.error('Error calling OpenAI:', error);
      // Fallback to rule-based
      return analyzeEmotionFallback(text);
    }
  };

  // Fallback khi API l·ªói - y√™u c·∫ßu user th·ª≠ l·∫°i
  const analyzeEmotionFallback = (text: string): boolean => {
    throw new Error('Kh√¥ng th·ªÉ ph√¢n t√≠ch c·∫£m x√∫c. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi API.');
  };

  // Sinh c√¢u n√≥i m·ªõi b·∫±ng OpenAI
  const generateMessageWithAI = async (isNegative: boolean): Promise<string> => {
    try {
      const prompt = isNegative 
        ? 'T·∫°o 1 c√¢u b√¨nh lu·∫≠n ti√™u c·ª±c, b·∫Øt n·∫°t tr√™n m·∫°ng x√£ h·ªôi b·∫±ng ti·∫øng Vi·ªát (ng·∫Øn g·ªçn, 10-15 t·ª´). Ch·ªâ tr·∫£ v·ªÅ c√¢u b√¨nh lu·∫≠n, kh√¥ng gi·∫£i th√≠ch.'
        : 'T·∫°o 1 c√¢u b√¨nh lu·∫≠n t√≠ch c·ª±c, ƒë·ªông vi√™n tr√™n m·∫°ng x√£ h·ªôi b·∫±ng ti·∫øng Vi·ªát (ng·∫Øn g·ªçn, 10-15 t·ª´). Ch·ªâ tr·∫£ v·ªÅ c√¢u b√¨nh lu·∫≠n, kh√¥ng gi·∫£i th√≠ch.';

      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'gpt-3.5-turbo',
          messages: [
            {
              role: 'system',
              content: 'B·∫°n l√† ng∆∞·ªùi t·∫°o v√≠ d·ª• cho game gi√°o d·ª•c v·ªÅ ch·ªëng b·∫Øt n·∫°t m·∫°ng.'
            },
            {
              role: 'user',
              content: prompt
            }
          ],
          temperature: 0.8,
          max_tokens: 50
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        console.error('API Error:', errorData);
        throw new Error(`API Error: ${response.status}`);
      }

      if (!response.ok) {
        const errorData = await response.json();
        console.error('API Error:', errorData);
        throw new Error(`API Error: ${response.status}`);
      }

      const data = await response.json();
      
      if (!data.choices || !data.choices[0] || !data.choices[0].message) {
        console.error('Invalid API response:', data);
        throw new Error('Invalid API response format');
      }
      
      return data.choices[0].message.content.trim().replace(/['"]/g, '');
    } catch (error) {
      console.error('Error generating message:', error);
      throw new Error('Kh√¥ng th·ªÉ t·∫°o c√¢u h·ªèi m·ªõi. Vui l√≤ng ki·ªÉm tra API key v√† k·∫øt n·ªëi internet.');
    }
  };

  const getRandomMessage = async () => {
    const isNegative = Math.random() > 0.5;
    return await generateMessageWithAI(isNegative);
  };

  const startGame = async () => {
    setGameState('playing');
    setScore(0);
    setStreak(0);
    setRound(1);
    setUserInput('');
    setFeedback({ show: false, correct: false, message: '' });
    const newMessage = await getRandomMessage();
    setCurrentMessage(newMessage);
  };

  const addEmotionAnimation = (emoji: string) => {
    const newEmotion = {
      x: Math.random() * 80 + 10,
      y: 50,
      emoji: emoji,
      id: Date.now()
    };
    setEmotions(prev => [...prev, newEmotion]);
    setTimeout(() => {
      setEmotions(prev => prev.filter(e => e.id !== newEmotion.id));
    }, 2000);
  };

  const handleClassification = async (isNegative: boolean) => {
    setLoading(true);
    
    try {
      const actuallyNegative = await analyzeEmotionWithAI(currentMessage);
      const correct = isNegative === actuallyNegative;
      
      if (correct) {
        const points = 10 + streak * 5;
        setScore(prev => prev + points);
        setStreak(prev => prev + 1);
        addEmotionAnimation(isNegative ? 'üíî' : 'üíö');
        setFeedback({ 
          show: true, 
          correct: true, 
          message: `Ch√≠nh x√°c! +${points} ƒëi·ªÉm ${streak > 0 ? `(Streak x${streak + 1})` : ''}` 
        });
      } else {
        setStreak(0);
        addEmotionAnimation('‚ùå');
        setFeedback({ 
          show: true, 
          correct: false, 
          message: 'Ch∆∞a ƒë√∫ng. H√£y ƒë·ªçc k·ªπ h∆°n nh√©!' 
        });
      }
      
      setLoading(false);
      
      setTimeout(async () => {
        setFeedback({ show: false, correct: false, message: '' });
        setRound(prev => prev + 1);
        const newMessage = await getRandomMessage();
        setCurrentMessage(newMessage);
      }, 2000);
    } catch (error) {
      setLoading(false);
      const errorMessage = error instanceof Error ? error.message : 'L·ªói kh√¥ng x√°c ƒë·ªãnh';
      setFeedback({ 
        show: true, 
        correct: false, 
        message: `‚ùå ${errorMessage}` 
      });
      // T·ª± ƒë·ªông ·∫©n error sau 5s
      setTimeout(() => {
        setFeedback({ show: false, correct: false, message: '' });
      }, 5000);
    }
  };

  const transformToPositive = async () => {
    if (!userInput.trim()) return;
    
    setLoading(true);
    
    try {
      const wasNegative = await analyzeEmotionWithAI(currentMessage);
      const nowPositive = !(await analyzeEmotionWithAI(userInput));
      
      if (wasNegative && nowPositive) {
        const healingPoints = 20 + streak * 10;
        setScore(prev => prev + healingPoints);
        setStreak(prev => prev + 1);
        addEmotionAnimation('‚ú®');
        setFeedback({ 
          show: true, 
          correct: true, 
          message: `Tuy·ªát v·ªùi! B·∫°n ƒë√£ ch·ªØa l√†nh c√¢u n√≥i! +${healingPoints} ƒëi·ªÉm üíñ` 
        });
      } else {
        setStreak(0);
        setFeedback({ 
          show: true, 
          correct: false, 
          message: 'H√£y th·ª≠ bi·∫øn ƒë·ªïi th√†nh l·ªùi n√≥i t√≠ch c·ª±c h∆°n nh√©!' 
        });
      }
      
      setLoading(false);
      setUserInput('');
      
      setTimeout(async () => {
        setFeedback({ show: false, correct: false, message: '' });
        setRound(prev => prev + 1);
        const newMessage = await getRandomMessage();
        setCurrentMessage(newMessage);
      }, 2500);
    } catch (error) {
      setLoading(false);
      const errorMessage = error instanceof Error ? error.message : 'L·ªói kh√¥ng x√°c ƒë·ªãnh';
      setFeedback({ 
        show: true, 
        correct: false, 
        message: `‚ùå ${errorMessage}` 
      });
      // T·ª± ƒë·ªông ·∫©n error sau 5s
      setTimeout(() => {
        setFeedback({ show: false, correct: false, message: '' });
      }, 5000);
    }
  };

  // Setup Screen - API Key Input
  if (gameState === 'setup') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-pink-900 via-purple-900 to-indigo-900 flex items-center justify-center p-4">
        <div className="max-w-md w-full text-center">
          <Key className="w-16 h-16 mx-auto text-pink-400 mb-4" />
          <h2 className="text-3xl font-bold text-white mb-4">C√†i ƒë·∫∑t OpenAI API</h2>
          
          <div className="bg-slate-800 bg-opacity-50 backdrop-blur rounded-lg p-6 mb-4 border border-pink-500 border-opacity-30">
            <label className="block text-left text-sm font-semibold text-gray-300 mb-2">
              üîë Nh·∫≠p OpenAI API Key:
            </label>
            <input
              type="password"
              value={apiKey}
              onChange={(e) => setApiKey(e.target.value)}
              placeholder="sk-proj-..."
              className="w-full bg-slate-700 text-white px-4 py-3 rounded border border-slate-600 focus:border-pink-500 focus:outline-none mb-3"
            />
            <p className="text-xs text-gray-400 text-left">
              üí° API key c·ªßa b·∫°n ch·ªâ l∆∞u trong session n√†y v√† kh√¥ng ƒë∆∞·ª£c g·ª≠i ƒëi ƒë√¢u kh√°c ngo√†i OpenAI
            </p>
          </div>

          <button
            onClick={() => apiKey.trim() && setGameState('menu')}
            disabled={!apiKey.trim()}
            className="w-full bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-700 hover:to-purple-700 disabled:from-slate-600 disabled:to-slate-600 text-white font-bold py-3 rounded-lg transition"
          >
            Ti·∫øp t·ª•c ‚Üí
          </button>

          <div className="mt-4 text-xs text-gray-400">
            <p>üîí Kh√¥ng c√≥ OpenAI API key?</p>
            <a 
              href="https://platform.openai.com/api-keys" 
              target="_blank" 
              rel="noopener noreferrer"
              className="text-pink-400 hover:text-pink-300 underline"
            >
              T·∫°o t·∫°i ƒë√¢y (mi·ªÖn ph√≠ $5 credit)
            </a>
          </div>
        </div>
      </div>
    );
  }

  // Menu Component
  if (gameState === 'menu') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-pink-900 via-purple-900 to-indigo-900 flex items-center justify-center p-4">
        <div className="max-w-md w-full text-center">
          <div className="mb-8 animate-bounce">
            <Heart className="w-20 h-20 mx-auto text-pink-400 mb-4 fill-pink-400" />
            <h1 className="text-5xl font-bold text-white mb-2">EMPATHY DEFENDER</h1>
            <p className="text-pink-300 text-lg">Ch·ªëng b·∫Øt n·∫°t m·∫°ng - Lan t·ªèa y√™u th∆∞∆°ng</p>
          </div>

          <div className="bg-slate-800 bg-opacity-50 backdrop-blur rounded-lg p-6 mb-6 border border-pink-500 border-opacity-30">
            <h2 className="text-xl font-bold text-white mb-3">üéØ M·ª•c ti√™u game</h2>
            <p className="text-gray-300 mb-4">
              Ph√¢n bi·ªát l·ªùi n√≥i <span className="text-red-400 font-bold">ti√™u c·ª±c</span> v√† <span className="text-green-400 font-bold">t√≠ch c·ª±c</span> tr√™n m·∫°ng x√£ h·ªôi.
              Chuy·ªÉn ƒë·ªïi l·ªùi n√≥i b·∫°o l·ª±c th√†nh l·ªùi n√≥i ƒë·ªìng c·∫£m!
            </p>
          </div>

          <div className="bg-slate-800 bg-opacity-50 backdrop-blur rounded-lg p-6 mb-6 border border-purple-500 border-opacity-30">
            <h3 className="text-lg font-bold text-white mb-3">üìö B·∫°n s·∫Ω h·ªçc ƒë∆∞·ª£c:</h3>
            <div className="text-left text-gray-300 space-y-2 text-sm">
              <p>‚úÖ Nh·∫≠n bi·∫øt ng√¥n t·ª´ g√¢y t·ªïn th∆∞∆°ng</p>
              <p>üí¨ Chuy·ªÉn ƒë·ªïi l·ªùi n√≥i ti√™u c·ª±c th√†nh t√≠ch c·ª±c</p>
              <p>üõ°Ô∏è B·∫£o v·ªá b·∫£n th√¢n kh·ªèi b·∫°o l·ª±c m·∫°ng</p>
              <p>üíñ Lan t·ªèa s·ª± ƒë·ªìng c·∫£m v√† t·ª≠ t·∫ø</p>
            </div>
          </div>

          <div className="bg-green-600 bg-opacity-20 border border-green-500 rounded-lg p-3 mb-6">
            <p className="text-green-300 text-sm">
              ü§ñ <strong>Powered by OpenAI GPT</strong> - C√¢u h·ªèi t·ª± ƒë·ªông sinh & ph√¢n t√≠ch th√¥ng minh
            </p>
          </div>

          <button
            onClick={startGame}
            className="w-full bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-700 hover:to-purple-700 text-white font-bold py-4 rounded-lg transition transform hover:scale-105 shadow-lg"
          >
            ‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu ch∆°i
          </button>

          <div className="mt-6 text-sm text-gray-400">
            <p>üí° M·ªói l·∫ßn ph√¢n lo·∫°i ƒë√∫ng: +10 ƒëi·ªÉm</p>
            <p>‚ú® Ch·ªØa l√†nh l·ªùi n√≥i: +20 ƒëi·ªÉm</p>
            <p>üî• Streak combo: ƒêi·ªÉm th∆∞·ªüng x2, x3...</p>
          </div>
        </div>
      </div>
    );
  }

  // Playing Component
  return (
    <div className="min-h-screen bg-gradient-to-br from-pink-900 via-purple-900 to-indigo-900 p-4 relative overflow-hidden">
      {/* Emotion Animations */}
      {emotions.map(emotion => (
        <div
          key={emotion.id}
          className="absolute text-4xl"
          style={{
            left: `${emotion.x}%`,
            top: `${emotion.y}%`,
            animation: 'float 2s ease-out forwards'
          }}
        >
          {emotion.emoji}
        </div>
      ))}

      <style jsx>{`
        @keyframes float {
          0% {
            transform: translateY(0) scale(1);
            opacity: 1;
          }
          100% {
            transform: translateY(-100px) scale(1.5);
            opacity: 0;
          }
        }
      `}</style>

      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <div className="text-center mb-6">
          <div className="flex items-center justify-center gap-3 mb-2">
            <Heart className="w-10 h-10 text-pink-400 fill-pink-400" />
            <h1 className="text-4xl font-bold text-white">EMPATHY DEFENDER</h1>
          </div>
          <p className="text-pink-300">Nh·∫≠n di·ªán & ch·ªØa l√†nh l·ªùi n√≥i b·∫°o l·ª±c</p>
          <p className="text-gray-400 text-sm mt-1">üéÆ V√≤ng {round}</p>
        </div>

        {/* Score & Streak */}
        <div className="flex gap-4 mb-6 justify-center">
          <div className="bg-slate-800 bg-opacity-50 backdrop-blur rounded-lg p-4 border border-pink-500 border-opacity-30 min-w-[150px] text-center">
            <div className="text-3xl font-bold text-pink-400">{score}</div>
            <div className="text-sm text-gray-400">ƒêi·ªÉm</div>
          </div>
          {streak > 0 && (
            <div className="bg-slate-800 bg-opacity-50 backdrop-blur rounded-lg p-4 border border-orange-500 border-opacity-30 min-w-[150px] text-center animate-pulse">
              <div className="text-3xl font-bold text-orange-400">üî• x{streak}</div>
              <div className="text-sm text-gray-400">Streak</div>
            </div>
          )}
        </div>

        {/* Message Display */}
        <div className="bg-slate-800 bg-opacity-50 backdrop-blur rounded-lg p-6 border border-purple-500 border-opacity-30 mb-6">
          <div className="flex items-start gap-3 mb-4">
            <div className="w-10 h-10 bg-gray-600 rounded-full flex items-center justify-center flex-shrink-0">
              üë§
            </div>
            <div className="flex-1 bg-slate-700 rounded-lg p-4">
              {currentMessage ? (
                <p className="text-white text-lg">{currentMessage}</p>
              ) : (
                <div className="flex items-center gap-2 text-gray-400">
                  <Zap className="w-5 h-5 animate-spin" />
                  <span>ƒêang t·∫°o c√¢u h·ªèi m·ªõi...</span>
                </div>
              )}
            </div>
          </div>

          {/* Classification Buttons */}
          <div className="grid grid-cols-2 gap-4 mb-4">
            <button
              onClick={() => handleClassification(true)}
              disabled={loading || !currentMessage}
              className="bg-red-600 hover:bg-red-700 disabled:bg-slate-600 text-white font-bold py-3 rounded-lg transition transform hover:scale-105 flex items-center justify-center gap-2"
            >
              <Frown className="w-5 h-5" />
              Ti√™u c·ª±c üíî
            </button>
            <button
              onClick={() => handleClassification(false)}
              disabled={loading || !currentMessage}
              className="bg-green-600 hover:bg-green-700 disabled:bg-slate-600 text-white font-bold py-3 rounded-lg transition transform hover:scale-105 flex items-center justify-center gap-2"
            >
              <Smile className="w-5 h-5" />
              T√≠ch c·ª±c üíö
            </button>
          </div>

          {/* Feedback */}
          {feedback.show && (
            <div className={`p-4 rounded-lg mb-4 ${feedback.correct ? 'bg-green-600' : 'bg-red-600'} bg-opacity-20 border ${feedback.correct ? 'border-green-500' : 'border-red-500'} animate-pulse`}>
              <p className="text-white text-center font-semibold">{feedback.message}</p>
            </div>
          )}

          {/* Healing Section */}
          <div className="border-t border-gray-600 pt-4">
            <label className="block text-sm font-semibold text-pink-300 mb-2">
              ‚ú® Ch·ªØa l√†nh: Bi·∫øn c√¢u tr√™n th√†nh l·ªùi n√≥i t√≠ch c·ª±c
            </label>
            <div className="flex gap-2">
              <input
                ref={inputRef}
                value={userInput}
                onChange={(e) => setUserInput(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && !loading && userInput.trim() && transformToPositive()}
                placeholder="V√≠ d·ª•: B·∫°n r·∫•t tuy·ªát v·ªùi, h√£y c·ªë g·∫Øng nh√©!"
                className="flex-1 bg-slate-700 text-white px-4 py-3 rounded border border-slate-600 focus:border-pink-500 focus:outline-none"
                disabled={loading || !currentMessage}
              />
              <button
                onClick={transformToPositive}
                disabled={loading || !userInput.trim() || !currentMessage}
                className="bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-700 hover:to-purple-700 disabled:from-slate-600 disabled:to-slate-600 text-white px-6 py-3 rounded font-semibold transition flex items-center gap-2"
              >
                {loading ? <Zap className="w-5 h-5 animate-spin" /> : <Heart className="w-5 h-5 fill-white" />}
              </button>
            </div>
          </div>
        </div>

        {/* Tips */}
        <div className="bg-slate-800 bg-opacity-30 backdrop-blur rounded-lg p-4 border border-indigo-500 border-opacity-20">
          <p className="text-gray-300 text-sm text-center">
            üí° <span className="font-bold text-pink-300">M·∫πo:</span> AI ƒëang ph√¢n t√≠ch ng·ªØ nghƒ©a s√¢u h∆°n c·∫£ t·ª´ ng·ªØ. 
            H√£y ch√∫ √Ω ƒë·∫øn ng·ªØ c·∫£nh v√† c·∫£m x√∫c th·∫≠t s·ª± ƒë·∫±ng sau c√¢u n√≥i!
          </p>
        </div>
      </div>
    </div>
  );
}